<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ã–zel Ders PiyasasÄ± Analizi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        body { background: #111827; }
        .chart-container { position: relative; height: 250px; }
    </style>
</head>
<body class="min-h-screen text-white p-4">
    
    <!-- Config Modal -->
    <div id="configModal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl p-6 max-w-sm w-full mx-4">
            <h2 class="text-xl font-bold mb-4">ğŸ”§ Supabase BaÄŸlantÄ±sÄ±</h2>
            <input type="text" id="supabaseUrl" placeholder="https://xxx.supabase.co"
                class="w-full px-3 py-2 mb-3 bg-gray-700 rounded text-white text-sm">
            <input type="password" id="supabaseKey" placeholder="anon key"
                class="w-full px-3 py-2 mb-4 bg-gray-700 rounded text-white text-sm">
            <button onclick="connect()" class="w-full py-2 bg-blue-600 hover:bg-blue-700 rounded font-semibold">
                BaÄŸlan
            </button>
        </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-40">
        <div class="animate-spin h-12 w-12 border-4 border-blue-500 border-t-transparent rounded-full"></div>
    </div>

    <!-- Main -->
    <div id="main" class="hidden max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">ğŸ“Š Ã–zel Ders PiyasasÄ±</h1>
            <button onclick="document.getElementById('configModal').classList.remove('hidden')" 
                class="px-3 py-1 bg-gray-700 rounded text-sm">âš™ï¸</button>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-3 md:grid-cols-6 gap-3 mb-6">
            <div class="bg-blue-900/50 rounded-lg p-3 text-center">
                <div class="text-blue-300 text-xs">Toplam</div>
                <div id="s1" class="text-xl font-bold">-</div>
            </div>
            <div class="bg-green-900/50 rounded-lg p-3 text-center">
                <div class="text-green-300 text-xs">Ortalama</div>
                <div id="s2" class="text-xl font-bold">-</div>
            </div>
            <div class="bg-yellow-900/50 rounded-lg p-3 text-center">
                <div class="text-yellow-300 text-xs">Medyan</div>
                <div id="s3" class="text-xl font-bold">-</div>
            </div>
            <div class="bg-purple-900/50 rounded-lg p-3 text-center">
                <div class="text-purple-300 text-xs">Min</div>
                <div id="s4" class="text-xl font-bold">-</div>
            </div>
            <div class="bg-pink-900/50 rounded-lg p-3 text-center">
                <div class="text-pink-300 text-xs">Max</div>
                <div id="s5" class="text-xl font-bold">-</div>
            </div>
            <div class="bg-cyan-900/50 rounded-lg p-3 text-center">
                <div class="text-cyan-300 text-xs">Online</div>
                <div id="s6" class="text-xl font-bold">-</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="bg-gray-800/50 rounded-lg p-4">
                <h3 class="font-semibold mb-2 text-sm">ğŸ“š Kategori DaÄŸÄ±lÄ±mÄ±</h3>
                <div class="chart-container"><canvas id="c1"></canvas></div>
            </div>
            <div class="bg-gray-800/50 rounded-lg p-4">
                <h3 class="font-semibold mb-2 text-sm">ğŸ’° Kategori FiyatlarÄ±</h3>
                <div class="chart-container"><canvas id="c2"></canvas></div>
            </div>
            <div class="bg-gray-800/50 rounded-lg p-4">
                <h3 class="font-semibold mb-2 text-sm">ğŸ™ï¸ Åehirler</h3>
                <div class="chart-container"><canvas id="c3"></canvas></div>
            </div>
            <div class="bg-gray-800/50 rounded-lg p-4">
                <h3 class="font-semibold mb-2 text-sm">ğŸ“ˆ Fiyat AralÄ±klarÄ±</h3>
                <div class="chart-container"><canvas id="c4"></canvas></div>
            </div>
        </div>

        <!-- Tables -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-gray-800/50 rounded-lg p-4">
                <h3 class="font-semibold mb-2 text-sm">ğŸ—ºï¸ Åehir Detay</h3>
                <table class="w-full text-sm">
                    <thead><tr class="text-gray-400 text-left"><th class="pb-2">Åehir</th><th class="pb-2 text-right">Adet</th><th class="pb-2 text-right">Ort.</th></tr></thead>
                    <tbody id="t1"></tbody>
                </table>
            </div>
            <div class="bg-gray-800/50 rounded-lg p-4">
                <h3 class="font-semibold mb-2 text-sm">ğŸ“– Kategori Detay</h3>
                <table class="w-full text-sm">
                    <thead><tr class="text-gray-400 text-left"><th class="pb-2">Kategori</th><th class="pb-2 text-right">Adet</th><th class="pb-2 text-right">Ort.</th></tr></thead>
                    <tbody id="t2"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const COLORS = ['#3B82F6','#10B981','#F59E0B','#EF4444','#8B5CF6','#EC4899','#06B6D4','#84CC16'];
        let charts = {};

        window.onload = () => {
            const u = localStorage.getItem('sb_url');
            const k = localStorage.getItem('sb_key');
            if (u && k) {
                document.getElementById('supabaseUrl').value = u;
                document.getElementById('supabaseKey').value = k;
            }
        };

        async function connect() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            if (!url || !key) return alert('URL ve Key gerekli');

            localStorage.setItem('sb_url', url);
            localStorage.setItem('sb_key', key);

            document.getElementById('configModal').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');

            try {
                const res = await fetch(`${url}/rest/v1/listings?select=*`, {
                    headers: { 'apikey': key, 'Authorization': `Bearer ${key}` }
                });
                if (!res.ok) throw new Error(res.status);
                const data = await res.json();
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main').classList.remove('hidden');
                analyze(data);
            } catch (e) {
                document.getElementById('loading').classList.add('hidden');
                alert('Hata: ' + e.message);
                document.getElementById('configModal').classList.remove('hidden');
            }
        }

        function analyze(data) {
            const prices = data.filter(d => d.price_per_hour).map(d => d.price_per_hour);
            const avg = prices.length ? Math.round(prices.reduce((a,b) => a+b, 0) / prices.length) : 0;
            const sorted = [...prices].sort((a,b) => a-b);
            const med = sorted.length ? Math.round(sorted[Math.floor(sorted.length/2)]) : 0;

            document.getElementById('s1').textContent = data.length;
            document.getElementById('s2').textContent = avg + 'â‚º';
            document.getElementById('s3').textContent = med + 'â‚º';
            document.getElementById('s4').textContent = (prices.length ? Math.min(...prices) : 0) + 'â‚º';
            document.getElementById('s5').textContent = (prices.length ? Math.max(...prices) : 0) + 'â‚º';
            document.getElementById('s6').textContent = data.filter(d => d.lesson_type === 'online' || d.lesson_type === 'both').length;

            // Kategori
            const catMap = {};
            data.forEach(d => {
                const c = (d.category_raw || 'diger').toLowerCase();
                if (!catMap[c]) catMap[c] = {n: 0, p: []};
                catMap[c].n++;
                if (d.price_per_hour) catMap[c].p.push(d.price_per_hour);
            });
            const cats = Object.entries(catMap).map(([k,v]) => ({
                name: k.charAt(0).toUpperCase() + k.slice(1),
                count: v.n,
                avg: v.p.length ? Math.round(v.p.reduce((a,b)=>a+b,0)/v.p.length) : 0
            })).sort((a,b) => b.count - a.count).slice(0,8);

            // Åehir
            const cityMap = {};
            data.forEach(d => {
                let c = d.location_raw || 'Bilinmiyor';
                if (c.includes(',')) c = c.split(',').pop().trim();
                if (!cityMap[c]) cityMap[c] = {n: 0, p: []};
                cityMap[c].n++;
                if (d.price_per_hour) cityMap[c].p.push(d.price_per_hour);
            });
            const cities = Object.entries(cityMap).map(([k,v]) => ({
                name: k, count: v.n,
                avg: v.p.length ? Math.round(v.p.reduce((a,b)=>a+b,0)/v.p.length) : 0
            })).sort((a,b) => b.count - a.count).slice(0,8);

            // Fiyat aralÄ±klarÄ±
            const ranges = [{n:'0-300',min:0,max:300,c:0},{n:'300-500',min:300,max:500,c:0},
                {n:'500-800',min:500,max:800,c:0},{n:'800-1200',min:800,max:1200,c:0},{n:'1200+',min:1200,max:1e9,c:0}];
            prices.forEach(p => { const r = ranges.find(x => p >= x.min && p < x.max); if(r) r.c++; });

            // Charts
            const opts = {responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
                scales:{x:{grid:{color:'#333'},ticks:{color:'#999'}},y:{grid:{color:'#333'},ticks:{color:'#999'}}}};

            if(charts.c1) charts.c1.destroy();
            charts.c1 = new Chart(document.getElementById('c1'), {
                type:'bar', data:{labels:cats.map(x=>x.name),datasets:[{data:cats.map(x=>x.count),backgroundColor:COLORS}]},
                options:{...opts,indexAxis:'y'}
            });

            if(charts.c2) charts.c2.destroy();
            charts.c2 = new Chart(document.getElementById('c2'), {
                type:'bar', data:{labels:cats.map(x=>x.name),datasets:[{data:cats.map(x=>x.avg),backgroundColor:'#10B981'}]},
                options:{...opts,indexAxis:'y'}
            });

            if(charts.c3) charts.c3.destroy();
            charts.c3 = new Chart(document.getElementById('c3'), {
                type:'doughnut', data:{labels:cities.slice(0,6).map(x=>x.name),datasets:[{data:cities.slice(0,6).map(x=>x.count),backgroundColor:COLORS}]},
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:'#999',boxWidth:12,padding:8}}}}
            });

            if(charts.c4) charts.c4.destroy();
            charts.c4 = new Chart(document.getElementById('c4'), {
                type:'bar', data:{labels:ranges.map(x=>x.n),datasets:[{data:ranges.map(x=>x.c),backgroundColor:'#F59E0B'}]},
                options:opts
            });

            // Tables
            document.getElementById('t1').innerHTML = cities.map(x => 
                `<tr class="border-t border-gray-700"><td class="py-1">${x.name}</td><td class="text-right">${x.count}</td><td class="text-right text-green-400">${x.avg}â‚º</td></tr>`
            ).join('');

            document.getElementById('t2').innerHTML = cats.map(x => 
                `<tr class="border-t border-gray-700"><td class="py-1">${x.name}</td><td class="text-right">${x.count}</td><td class="text-right text-green-400">${x.avg}â‚º</td></tr>`
            ).join('');
        }
    </script>
</body>
</html>
